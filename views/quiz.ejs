<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="/app/css/style.css" />
    <title>Simple Quiz</title>
  </head>
  <body>
    <nav
      class="navbar"
      style="
        background-color: #f8f9fa;
        padding: 12px 0;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 30px;
      "
    >
      <div
        style="
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%;
        "
      >
        <div style="font-size: 18px; font-weight: 500">Quiz Application</div>
        <a
          href="/"
          style="
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
          "
          >‚Üê Back to Blog</a
        >
      </div>
    </nav>
    <div class="quizContainer">
      <h1>Quiz Application</h1>
      <% if (knowledgeArea) { %> <% const displayName =
      knowledgeArea.split('_').map(word => word.charAt(0).toUpperCase() +
      word.slice(1)).join(' '); %>
      <p class="knowledge-area-badge">
        Knowledge Area: <strong><%= displayName %></strong>
      </p>
      <% } %> <% if (totalQuestions === 0) { %>
      <div class="no-data">
        <p>No questions found for this knowledge area.</p>
        <a href="/app/" class="btn btn-reset">Back to Selection</a>
      </div>
      <% } else { %>
      <form id="quizForm">
        <input
          type="hidden"
          name="knowledgeArea"
          value="<%= knowledgeArea || '' %>"
        />
        <input type="hidden" name="systemId" value="<%= systemId || '' %>" />

        <% questions.forEach((question, index) => { %>
        <div class="question">
          <h3>Question <%= index + 1 %> of <%= totalQuestions %></h3>
          <p class="question-text"><%= question.question %></p>

          <div class="answers">
            <% Object.keys(question.choices).forEach(index => { %> <% const
            letterIndex = ['a', 'b', 'c', 'd'][index]; %>
            <label class="answer-label">
              <input
                type="radio"
                name="question_<%= question.id %>"
                value="<%= index %>"
                required
              />
              <span class="answer-letter"
                ><%= letterIndex.toUpperCase() %>:</span
              >
              <%= question.choices[index] %>
            </label>
            <% }); %>
          </div>
        </div>
        <% }); %>

        <div class="button-group">
          <button
            type="button"
            class="btn btn-submit"
            onclick="submitQuizForm()"
          >
            Submit Quiz
          </button>
          <a href="/app/" class="btn btn-reset">Back to Selection</a>
        </div>
      </form>

      <script>
        function submitQuizForm() {
          const form = document.getElementById("quizForm");
          const formData = new FormData(form);

          // Convert FormData to JSON object
          const data = {
            knowledgeArea: formData.get("knowledgeArea"),
            systemId: formData.get("systemId"),
          };

          // Extract all question answers
          for (const [key, value] of formData.entries()) {
            if (key.startsWith("question_")) {
              data[key] = value;
            }
          }

          // Show loading indicator
          document.querySelector(".btn-submit").disabled = true;
          document.querySelector(".btn-submit").textContent = "Submitting...";

          // Send as JSON via fetch
          fetch("/app/submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (!response.ok) throw new Error("Network response was not ok");
              return response.text();
            })
            .then((html) => {
              document.documentElement.innerHTML = html;
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error submitting quiz. Please try again.");
              document.querySelector(".btn-submit").disabled = false;
              document.querySelector(".btn-submit").textContent = "Submit Quiz";
            });
        }
      </script>
      <% } %>
    </div>
  </body>
</html>
